pid /tmp/nginx.pid;

events {}

http {
  # Unprivileged image: temp paths must be writable.
  client_body_temp_path /tmp/client_temp;
  proxy_temp_path       /tmp/proxy_temp;

  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout  65;
  server_tokens off;

  # Gzip is safe for json/html/css/js. Vector tiles are often already gzipped by upstream,
  # but leaving gzip enabled doesn't double-compress if upstream sets Content-Encoding: gzip.
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_types
    text/plain
    text/css
    application/javascript
    application/json
    application/geo+json
    application/x-protobuf
    application/octet-stream
    application/vnd.mapbox-vector-tile;

  # Cache for vector tiles (.pbf) and glyphs/sprites.
  # 50m keys zone ~= tens/hundreds of thousands of tile keys.
  proxy_cache_path /tmp/nginx-cache
    levels=1:2
    keys_zone=tiles:50m
    inactive=30d
    max_size=8g
    use_temp_path=off;

  upstream tileserver_upstream {
    server tileserver:8080;
    keepalive 32;
  }

  server {
    listen 8080;
    server_name _;

    # Demo app
    root /usr/share/nginx/html;
    index index.html;

    # Security-ish headers (HTTP only for now; HSTS must wait for HTTPS).
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy no-referrer-when-downgrade always;

    # Serve style at the exact path requested: /styles/style.json
    location = /styles/style.json {
      default_type application/json;
      alias /srv/styles/style.json;
      add_header Cache-Control "public, max-age=300" always;
    }

    # Optional: allow browsing /styles/ directory for your own files.
    location /styles/ {
      alias /srv/styles/;
      autoindex off;
      add_header Cache-Control "public, max-age=300" always;
      try_files $uri =404;
    }

    # Cache vector tiles hard. Clients request these constantly.
    location ~* ^/data/.+\.pbf$ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_cache tiles;
      proxy_cache_lock on;
      proxy_cache_revalidate on;
      proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;

      proxy_cache_valid 200 301 302 365d;
      proxy_cache_valid 404 1m;

      add_header Cache-Control "public, max-age=31536000, immutable" always;
      add_header X-Cache-Status $upstream_cache_status always;

      proxy_pass http://tileserver_upstream;
    }

    # Sprites are plain static files.
    location ^~ /sprites/ {
      root /srv;
      add_header Cache-Control "public, max-age=31536000, immutable" always;
      try_files $uri =404;
    }

    # Glyph requests may include multiple fonts in one URL:
    #   /fonts/Font1,Font2/{range}.pbf
    # TileServer-GL merges glyphs, so we must proxy (not serve as static files).
    location ^~ /fonts/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_cache tiles;
      proxy_cache_lock on;
      proxy_cache_revalidate on;
      proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;

      proxy_cache_valid 200 301 302 365d;
      proxy_cache_valid 404 5m;

      add_header Cache-Control "public, max-age=31536000, immutable" always;
      add_header X-Cache-Status $upstream_cache_status always;

      proxy_pass http://tileserver_upstream;
    }

    # Pass everything else to tileserver (health, /data/*.json, etc),
    # but keep "/" as the demo app.
    location = / {
      try_files /index.html =404;
    }

    location / {
      # If a file exists in /web (demo), serve it; else proxy to tileserver.
      try_files $uri @tileserver;
    }

    location @tileserver {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://tileserver_upstream;
    }
  }
}
